<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>【苍穹外卖】（12）SpringTask（定时任务）、Websocket（来单提醒、催单） | SteamedFish&#39;s Blog</title>
<meta name="keywords" content="Spring Task, 苍穹外卖, WebSocket">
<meta name="description" content="Spring Task
介绍
Spring Task 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。

定位：定时任务框架
作用：定时自动执行某段Java代码
应用场景：

信用卡每月还款提醒
银行贷款每月还款提醒
火车票售票系统处理未支付订单
入职纪念日为用户发送通知





    
        
            
        信息">
<meta name="author" content="">
<link rel="canonical" href="https://www.steamedfish.top/post/java-project/sky-take-out/sky-take-out-13/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.c27e1246cb66d388c2c28ba2cad7d8e45b296bdd6da67c05cf15ef27e74594b2.css" integrity="sha256-wn4SRstm04jCwouiytfY5Fspa91tpnwFzxXvJ&#43;dFlLI=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://www.steamedfish.top/favicon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.steamedfish.top/favicon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.steamedfish.top/favicon.png">
<link rel="apple-touch-icon" href="https://www.steamedfish.top/favicon.png">
<link rel="mask-icon" href="https://www.steamedfish.top/favicon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://www.steamedfish.top/post/java-project/sky-take-out/sky-take-out-13/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>





<link
  href="/fonts/lxgw/style.css"
  rel="stylesheet"
/><meta property="og:url" content="https://www.steamedfish.top/post/java-project/sky-take-out/sky-take-out-13/">
  <meta property="og:site_name" content="SteamedFish&#39;s Blog">
  <meta property="og:title" content="【苍穹外卖】（12）SpringTask（定时任务）、Websocket（来单提醒、催单）">
  <meta property="og:description" content="Spring Task 介绍 Spring Task 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。
定位：定时任务框架 作用：定时自动执行某段Java代码 应用场景： 信用卡每月还款提醒 银行贷款每月还款提醒 火车票售票系统处理未支付订单 入职纪念日为用户发送通知 信息">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-12-28T21:44:24+08:00">
    <meta property="article:modified_time" content="2025-12-29T00:38:42+08:00">
    <meta property="article:tag" content="Spring Task">
    <meta property="article:tag" content="苍穹外卖">
    <meta property="article:tag" content="WebSocket">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【苍穹外卖】（12）SpringTask（定时任务）、Websocket（来单提醒、催单）">
<meta name="twitter:description" content="Spring Task
介绍
Spring Task 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。

定位：定时任务框架
作用：定时自动执行某段Java代码
应用场景：

信用卡每月还款提醒
银行贷款每月还款提醒
火车票售票系统处理未支付订单
入职纪念日为用户发送通知





    
        
            
        信息">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://www.steamedfish.top/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "【苍穹外卖】（12）SpringTask（定时任务）、Websocket（来单提醒、催单）",
      "item": "https://www.steamedfish.top/post/java-project/sky-take-out/sky-take-out-13/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "【苍穹外卖】（12）SpringTask（定时任务）、Websocket（来单提醒、催单）",
  "name": "【苍穹外卖】（12）SpringTask（定时任务）、Websocket（来单提醒、催单）",
  "description": "Spring Task 介绍 Spring Task 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。\n定位：定时任务框架 作用：定时自动执行某段Java代码 应用场景： 信用卡每月还款提醒 银行贷款每月还款提醒 火车票售票系统处理未支付订单 入职纪念日为用户发送通知 信息\n",
  "keywords": [
    "Spring Task", "苍穹外卖", "WebSocket"
  ],
  "articleBody": "Spring Task 介绍 Spring Task 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。\n定位：定时任务框架 作用：定时自动执行某段Java代码 应用场景： 信用卡每月还款提醒 银行贷款每月还款提醒 火车票售票系统处理未支付订单 入职纪念日为用户发送通知 信息\n只要是需要定时处理的场景都可以使用Spring Task\ncron表达式 cron表达式其实就是一个字符串，通过cron表达式可以定义任务触发的时间\n构成规则：分为6或7个域，由空格分隔开，每个域代表一个含义\n每个域的含义分别为：秒、分钟、小时、日、月、周、年(可选)\n2022年10月12日上午9点整 对应的cron表达式为：0 0 9 12 10 ? 2022\ncron表达式在线生成器： https://cron.ciding.cc/\nSpring Task使用步骤 导入maven坐标 spring-context（已存在） 启动类添加注解 @EnableScheduling 开启任务调度 自定义定时任务类 订单状态定时处理 需求分析 用户下单后可能存在的情况： 下单后未支付，订单一直处于“待支付”状态 用户收货后管理端未点击完成按钮，订单一直处于“派送中”状态 对于上面两种情况需要通过定时任务来修改订单状态，具体逻辑为：\n通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消” 通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成” 代码开发 com/sky/task/OrderTask.java package com.sky.task; import com.sky.entity.Orders; import com.sky.mapper.OrderMapper; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.scheduling.annotation.Scheduled; import org.springframework.stereotype.Component; import java.time.LocalDateTime; import java.util.List; @Component @Slf4j public class OrderTask { @Autowired private OrderMapper orderMapper; /** * 处理支付超时订单 * 下单后超过15分钟仍未支付的订单自动修改为取消状态 */ @Scheduled(cron = \"0 * * * * ?\")//每分钟 public void processTimeoutOrder(){ log.info(\"处理支付超时订单：{}\", LocalDateTime.now()); LocalDateTime time = LocalDateTime.now().plusMinutes(-15); List\u003cOrders\u003e ordersList = orderMapper.getByStatusAndOrderTimeOut(Orders.TO_BE_CONFIRMED, time); ordersList.forEach(orders -\u003e { orders.setStatus(Orders.CANCELLED); orders.setCancelTime(LocalDateTime.now()); orders.setCancelReason(\"支付超时，自动取消\"); orderMapper.update(orders); }); } /** * 派送超时订单 * 一直在派送中的订单自动修改为已完成 */ @Scheduled(cron = \"0 0 1 * * ?\")//每天凌晨一点 public void processDeliveryOrder(){ log.info(\"处理派送超时订单：{}\", LocalDateTime.now()); LocalDateTime time = LocalDateTime.now().plusMinutes(-60); List\u003cOrders\u003e ordersList = orderMapper.getByStatusAndOrderTimeOut(Orders.DELIVERY_IN_PROGRESS, time); ordersList.forEach(orders -\u003e { orders.setStatus(Orders.COMPLETED); orderMapper.update(orders); }); } } OrderMapper.java /** * 获取订单状态为待接单或待派送的订单 * @param status * @param time * @return */ List\u003cOrders\u003e getByStatusAndOrderTimeOut(Integer status, LocalDateTime time); OrderTask.xml ",
  "wordCount" : "2500",
  "inLanguage": "zh",
  "datePublished": "2025-12-28T21:44:24+08:00",
  "dateModified": "2025-12-29T00:38:42+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.steamedfish.top/post/java-project/sky-take-out/sky-take-out-13/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "SteamedFish's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.steamedfish.top/favicon.png"
    }
  }
}
</script>
</head>

<body data-barba="wrapper" class="" id="top">

<div id="aplayer"></div>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.steamedfish.top/" accesskey="h" title="SteamedFish&#39;s Blog (Alt + H)">SteamedFish&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                    <ul class="lang-switch"><li>|</li>
                        <li>
                            <a href="https://www.steamedfish.top/en/" title="English"
                                aria-label="English">En</a>
                        </li>
                    </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.steamedfish.top/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://www.steamedfish.top/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://www.steamedfish.top/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://www.steamedfish.top/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://www.steamedfish.top/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://www.steamedfish.top/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main" data-barba="container" data-barba-namespace="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      【苍穹外卖】（12）SpringTask（定时任务）、Websocket（来单提醒、催单）
    </h1>
    <div class="post-meta">






<span title='2025-12-28 21:44:24 +0800 +0800'>2025-12-28</span>&nbsp;·&nbsp;<span title='2025-12-29 00:38:42 +0800 +0800'>(最后修改于 2025-12-29)</span>&nbsp;·&nbsp;<span>5 分钟</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#spring-task" aria-label="Spring Task">Spring Task</a><ul>
                        
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d" aria-label="介绍">介绍</a></li>
                <li>
                    <a href="#cron%e8%a1%a8%e8%be%be%e5%bc%8f" aria-label="cron表达式">cron表达式</a></li>
                <li>
                    <a href="#spring-task%e4%bd%bf%e7%94%a8%e6%ad%a5%e9%aa%a4" aria-label="Spring Task使用步骤">Spring Task使用步骤</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e5%ae%9a%e6%97%b6%e5%a4%84%e7%90%86" aria-label="订单状态定时处理">订单状态定时处理</a><ul>
                        
                <li>
                    <a href="#%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90" aria-label="需求分析">需求分析</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%bc%80%e5%8f%91" aria-label="代码开发">代码开发</a></li></ul>
                </li>
                <li>
                    <a href="#websocket" aria-label="WebSocket">WebSocket</a><ul>
                        
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d-1" aria-label="介绍">介绍</a></li>
                <li>
                    <a href="#websocket%e4%bd%bf%e7%94%a8%e6%ad%a5%e9%aa%a4" aria-label="Websocket使用步骤">Websocket使用步骤</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%9d%a5%e5%8d%95%e6%8f%90%e9%86%92" aria-label="来单提醒">来单提醒</a><ul>
                        
                <li>
                    <a href="#%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90%e5%92%8c%e8%ae%be%e8%ae%a1" aria-label="需求分析和设计">需求分析和设计</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%bc%80%e5%8f%91-1" aria-label="代码开发">代码开发</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%a2%e6%88%b7%e5%82%ac%e5%8d%95" aria-label="客户催单">客户催单</a><ul>
                        
                <li>
                    <a href="#%e9%9c%80%e6%b1%82%e5%88%86%e6%9e%90%e5%92%8c%e8%ae%be%e8%ae%a1-1" aria-label="需求分析和设计">需求分析和设计</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%bc%80%e5%8f%91-2" aria-label="代码开发">代码开发</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="spring-task">Spring Task<a hidden class="anchor" aria-hidden="true" href="#spring-task">#</a></h2>
<h3 id="介绍">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍">#</a></h3>
<p>Spring Task 是Spring框架提供的<strong>任务调度工具</strong>，可以按照约定的时间自动执行某个代码逻辑。</p>
<ul>
<li>定位：定时任务框架</li>
<li>作用：定时自动执行某段Java代码</li>
<li>应用场景：
<ul>
<li>信用卡每月还款提醒</li>
<li>银行贷款每月还款提醒</li>
<li>火车票售票系统处理未支付订单</li>
<li>入职纪念日为用户发送通知</li>
</ul>
</li>
</ul>
<!-- FM:Snippet:Start data:{"id":"st-notice","fields":[]} -->
<style type="text/css">
     
    .notice {
        --title-color: #fff;
        --title-background-color: #6be;
        --content-color: #444;
        --content-background-color: #e7f2fa;
    }

    .notice.info {
        --title-background-color: #fb7;
        --content-background-color: #fec;
    }

    .notice.tip {
        --title-background-color: #5a5;
        --content-background-color: #efe;
    }

    .notice.warning {
        --title-background-color: #c33;
        --content-background-color: #fee;
    }

     
    

    body.dark .notice {
        --title-color: #fff;
        --title-background-color: #069;
        --content-color: #ddd;
        --content-background-color: #023;
    }

    body.dark .notice.info {
        --title-background-color: #a50;
        --content-background-color: #420;
    }

    body.dark .notice.tip {
        --title-background-color: #363;
        --content-background-color: #121;
    }

    body.dark .notice.warning {
        --title-background-color: #800;
        --content-background-color: #400;
    }

     
    .notice {
        padding: 18px;
        line-height: 24px;
        margin-bottom: 24px;
        border-radius: 4px;
        color: var(--content-color);
        background: var(--content-background-color);
    }

    .notice p:last-child {
        margin-bottom: 0
    }

     
    .notice-title {
        margin: -18px -18px 12px;
        padding: 4px 18px;
        border-radius: 4px 4px 0 0;
        font-weight: 700;
        color: var(--title-color);
        background: var(--title-background-color);
    }

     
    .icon-notice {
        display: inline-flex;
        align-self: center;
        margin-right: 8px;
    }

    .icon-notice img,
    .icon-notice svg {
        height: 1em;
        width: 1em;
        fill: currentColor;
    }

    .icon-notice img,
    .icon-notice.baseline svg {
        top: .125em;
        position: relative;
    }
</style><div class="notice info" >
    <p class="notice-title">
        <span class="icon-notice baseline">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc. --><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>
        </span>信息</p><p>只要是需要定时处理的场景都可以使用Spring Task</p></div>
<!-- FM:Snippet:End -->
<hr>
<h3 id="cron表达式">cron表达式<a hidden class="anchor" aria-hidden="true" href="#cron表达式">#</a></h3>
<p>cron表达式其实就是一个字符串，通过cron表达式可以<strong>定义任务触发的时间</strong><br>
构成规则：分为6或7个域，由空格分隔开，每个域代表一个含义<br>
每个域的含义分别为：秒、分钟、小时、日、月、周、年(可选)<br>






    


       
    



<div class="post-img-view">
  <a
    data-fancybox="post-post/java-project/sky-take-out/sky-take-out-13/index.md"
    href="/post/java-project/sky-take-out/sky-take-out-13/1.png"
    data-caption=""
    data-barba-prevent="all"
  >
    <img
      src="/post/java-project/sky-take-out/sky-take-out-13/1.png"
      srcset="/post/java-project/sky-take-out/sky-take-out-13/1.png 2x"
      alt=""
      loading="lazy"
      style="max-width: 100%; height: auto;"
    />
  </a>
    
  
</div>



2022年10月12日上午9点整 对应的cron表达式为：<code>0 0 9 12 10 ? 2022</code></p>
<blockquote>
<p>cron表达式在线生成器： <a href="https://cron.ciding.cc/">https://cron.ciding.cc/</a></p>
</blockquote>
<hr>
<h3 id="spring-task使用步骤">Spring Task使用步骤<a hidden class="anchor" aria-hidden="true" href="#spring-task使用步骤">#</a></h3>
<ol>
<li>导入maven坐标 spring-context（已存在）






    


       
    



<div class="post-img-view">
  <a
    data-fancybox="post-post/java-project/sky-take-out/sky-take-out-13/index.md"
    href="/post/java-project/sky-take-out/sky-take-out-13/2.png"
    data-caption=""
    data-barba-prevent="all"
  >
    <img
      src="/post/java-project/sky-take-out/sky-take-out-13/2.png"
      srcset="/post/java-project/sky-take-out/sky-take-out-13/2.png 2x"
      alt=""
      loading="lazy"
      style="max-width: 100%; height: auto;"
    />
  </a>
    
  
</div>


</li>
<li>启动类添加注解 <code>@EnableScheduling</code> 开启任务调度






    


       
    



<div class="post-img-view">
  <a
    data-fancybox="post-post/java-project/sky-take-out/sky-take-out-13/index.md"
    href="/post/java-project/sky-take-out/sky-take-out-13/3.webp"
    data-caption=""
    data-barba-prevent="all"
  >
    <img
      src="/post/java-project/sky-take-out/sky-take-out-13/3.webp"
      srcset="/post/java-project/sky-take-out/sky-take-out-13/3.webp 2x"
      alt=""
      loading="lazy"
      style="max-width: 100%; height: auto;"
    />
  </a>
    
  
</div>


</li>
<li>自定义定时任务类</li>
</ol>
<hr>
<h2 id="订单状态定时处理">订单状态定时处理<a hidden class="anchor" aria-hidden="true" href="#订单状态定时处理">#</a></h2>
<h3 id="需求分析">需求分析<a hidden class="anchor" aria-hidden="true" href="#需求分析">#</a></h3>
<ul>
<li>用户下单后可能存在的情况：
<ul>
<li>下单后未支付，订单一直处于“待支付”状态</li>
<li>用户收货后管理端未点击完成按钮，订单一直处于“派送中”状态</li>
</ul>
</li>
</ul>
<p>对于上面两种情况需要通过定时任务来修改订单状态，具体逻辑为：</p>
<ol>
<li>通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”</li>
<li>通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”</li>
</ol>
<hr>
<h3 id="代码开发">代码开发<a hidden class="anchor" aria-hidden="true" href="#代码开发">#</a></h3>
<ul>
<li><code>com/sky/task/OrderTask.java</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.sky.task</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sky.entity.Orders</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">com.sky.mapper.OrderMapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.scheduling.annotation.Scheduled</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderTask</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">OrderMapper</span><span class="w"> </span><span class="n">orderMapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 处理支付超时订单
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 下单后超过15分钟仍未支付的订单自动修改为取消状态
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 * * * * ?&#34;</span><span class="p">)</span><span class="c1">//每分钟</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processTimeoutOrder</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;处理支付超时订单：{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">plusMinutes</span><span class="p">(</span><span class="o">-</span><span class="n">15</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Orders</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ordersList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderMapper</span><span class="p">.</span><span class="na">getByStatusAndOrderTimeOut</span><span class="p">(</span><span class="n">Orders</span><span class="p">.</span><span class="na">TO_BE_CONFIRMED</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ordersList</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">orders</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">orders</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">Orders</span><span class="p">.</span><span class="na">CANCELLED</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">orders</span><span class="p">.</span><span class="na">setCancelTime</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">orders</span><span class="p">.</span><span class="na">setCancelReason</span><span class="p">(</span><span class="s">&#34;支付超时，自动取消&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">orderMapper</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">orders</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 派送超时订单
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 一直在派送中的订单自动修改为已完成
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 0 1 * * ?&#34;</span><span class="p">)</span><span class="c1">//每天凌晨一点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processDeliveryOrder</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;处理派送超时订单：{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">plusMinutes</span><span class="p">(</span><span class="o">-</span><span class="n">60</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Orders</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ordersList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderMapper</span><span class="p">.</span><span class="na">getByStatusAndOrderTimeOut</span><span class="p">(</span><span class="n">Orders</span><span class="p">.</span><span class="na">DELIVERY_IN_PROGRESS</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ordersList</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">orders</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">orders</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">Orders</span><span class="p">.</span><span class="na">COMPLETED</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">orderMapper</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">orders</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>OrderMapper.java</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 获取订单状态为待接单或待派送的订单
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param status
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param time
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Orders</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getByStatusAndOrderTimeOut</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">time</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>OrderTask.xml</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--查询未支付订单--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;getByStatusAndOrderTimeOut&#34;</span> <span class="na">resultType=</span><span class="s">&#34;com.sky.entity.Orders&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    select id,
</span></span><span class="line"><span class="cl">           number,
</span></span><span class="line"><span class="cl">           status,
</span></span><span class="line"><span class="cl">           user_id,
</span></span><span class="line"><span class="cl">           address_book_id,
</span></span><span class="line"><span class="cl">           order_time,
</span></span><span class="line"><span class="cl">           checkout_time,
</span></span><span class="line"><span class="cl">           pay_method,
</span></span><span class="line"><span class="cl">           pay_status,
</span></span><span class="line"><span class="cl">           amount,
</span></span><span class="line"><span class="cl">           remark,
</span></span><span class="line"><span class="cl">           phone,
</span></span><span class="line"><span class="cl">           address,
</span></span><span class="line"><span class="cl">           user_name,
</span></span><span class="line"><span class="cl">           consignee,
</span></span><span class="line"><span class="cl">           cancel_reason,
</span></span><span class="line"><span class="cl">           rejection_reason,
</span></span><span class="line"><span class="cl">           cancel_time,
</span></span><span class="line"><span class="cl">           estimated_delivery_time,
</span></span><span class="line"><span class="cl">           delivery_status,
</span></span><span class="line"><span class="cl">           delivery_time,
</span></span><span class="line"><span class="cl">           pack_amount,
</span></span><span class="line"><span class="cl">           tableware_number,
</span></span><span class="line"><span class="cl">           tableware_status
</span></span><span class="line"><span class="cl">    from orders
</span></span><span class="line"><span class="cl">    where status = #{status}
</span></span><span class="line"><span class="cl">      and order_time <span class="cp">&lt;![CDATA[&lt;=]]&gt;</span> #{time}
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/select&gt;</span>
</span></span></code></pre></div></li>
</ul>
<hr>
<h2 id="websocket">WebSocket<a hidden class="anchor" aria-hidden="true" href="#websocket">#</a></h2>
<h3 id="介绍-1">介绍<a hidden class="anchor" aria-hidden="true" href="#介绍-1">#</a></h3>
<p>WebSocket 是基于 TCP 的一种新的<strong>网络协议</strong>。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建<strong>持久性</strong>的连接， 并进行<strong>双向</strong>数据传输。






    


       
    



<div class="post-img-view">
  <a
    data-fancybox="post-post/java-project/sky-take-out/sky-take-out-13/index.md"
    href="/post/java-project/sky-take-out/sky-take-out-13/4.png"
    data-caption=""
    data-barba-prevent="all"
  >
    <img
      src="/post/java-project/sky-take-out/sky-take-out-13/4.png"
      srcset="/post/java-project/sky-take-out/sky-take-out-13/4.png 2x"
      alt=""
      loading="lazy"
      style="max-width: 100%; height: auto;"
    />
  </a>
    
  
</div>



HTTP协议和WebSocket协议对比：</p>
<ul>
<li>HTTP是<strong>短连接</strong></li>
<li>WebSocket是<strong>长连接</strong></li>
<li>HTTP通信是<strong>单向</strong>的，基于请求响应模式</li>
<li>WebSocket支持<strong>双向</strong>通信</li>
<li>HTTP和WebSocket底层都是TCP连接</li>
</ul>
<p>WebSocket缺点：</p>
<ul>
<li>服务器长期维护长连接需要一定的成本</li>
<li>各个浏览器支持程度不一</li>
<li>WebSocket 是长连接，受网络限制比较大，需要处理好重连</li>
</ul>
<!-- FM:Snippet:Start data:{"id":"st-notice","fields":[]} -->
<div class="notice info" >
    <p class="notice-title">
        <span class="icon-notice baseline">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc. --><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>
        </span>信息</p><p>WebSocket并不能完全取代HTTP，它只适合在特定的场景下使用</p></div>
<!-- FM:Snippet:End -->
<p>应用场景：</p>
<ul>
<li>视频弹幕</li>
<li>网页聊天</li>
<li>体育实况更新</li>
<li>股票基金报价实时更新</li>
</ul>
<hr>
<h3 id="websocket使用步骤">Websocket使用步骤<a hidden class="anchor" aria-hidden="true" href="#websocket使用步骤">#</a></h3>
<ol>
<li>导入WebSocket的maven坐标</li>
<li>导入WebSocket服务端组件WebSocketServer，用于和客户端通信</li>
<li>导入配置类WebSocketConfiguration，注册WebSocket的服务端组件</li>
<li>导入定时任务类WebSocketTask，定时向客户端推送数据</li>
</ol>
<hr>
<h2 id="来单提醒">来单提醒<a hidden class="anchor" aria-hidden="true" href="#来单提醒">#</a></h2>
<h3 id="需求分析和设计">需求分析和设计<a hidden class="anchor" aria-hidden="true" href="#需求分析和设计">#</a></h3>
<p>用户下单并且支付成功后，需要第一时间通知外卖商家。通知的形式有如下两种：</p>
<ul>
<li>语音播报</li>
<li>弹出提示框






    


       
    



<div class="post-img-view">
  <a
    data-fancybox="post-post/java-project/sky-take-out/sky-take-out-13/index.md"
    href="/post/java-project/sky-take-out/sky-take-out-13/5.webp"
    data-caption=""
    data-barba-prevent="all"
  >
    <img
      src="/post/java-project/sky-take-out/sky-take-out-13/5.webp"
      srcset="/post/java-project/sky-take-out/sky-take-out-13/5.webp 2x"
      alt=""
      loading="lazy"
      style="max-width: 100%; height: auto;"
    />
  </a>
    
  
</div>



设计：</li>
<li>通过WebSocket实现管理端页面和服务端保持长连接状态</li>
<li>当客户支付后，调用WebSocket的相关API实现服务端向客户端推送消息</li>
<li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</li>
<li>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content
<ul>
<li>type 为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId 为订单id</li>
<li>content 为消息内容</li>
</ul>
</li>
</ul>
<h3 id="代码开发-1">代码开发<a hidden class="anchor" aria-hidden="true" href="#代码开发-1">#</a></h3>
<ul>
<li><code>com/sky/websocket/WebSocketServer.java</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.sky.websocket</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.websocket.OnClose</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.websocket.OnMessage</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.websocket.OnOpen</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.websocket.Session</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.websocket.server.PathParam</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.websocket.server.ServerEndpoint</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * WebSocket服务
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="s">&#34;/ws/{sid}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSocketServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//存放会话对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Session</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sessionMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 连接建立成功调用的方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@OnOpen</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onOpen</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;sid&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">sid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;客户端：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;建立连接&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sessionMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 收到客户端消息后调用的方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param message 客户端发送过来的消息
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@OnMessage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;sid&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">sid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;收到来自客户端：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;的信息:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 连接关闭调用的方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param sid
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@OnClose</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onClose</span><span class="p">(</span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;sid&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">sid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;连接断开:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sid</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sessionMap</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 群发
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param message
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendToAllClient</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Session</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sessions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionMap</span><span class="p">.</span><span class="na">values</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">sessions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//服务器向客户端发送消息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">session</span><span class="p">.</span><span class="na">getBasicRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>com/sky/config/WebSocketConfiguration.java</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.sky.config</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.socket.server.standard.ServerEndpointExporter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * WebSocket配置类，用于注册WebSocket的Bean
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSocketConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ServerEndpointExporter</span><span class="w"> </span><span class="nf">serverEndpointExporter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServerEndpointExporter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
<li>修改<code>com/sky/service/impl/OrderServiceImpl.java</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 支付成功，修改订单状态
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param outTradeNo
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">paySuccess</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">outTradeNo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 根据订单号查询订单</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Orders</span><span class="w"> </span><span class="n">ordersDB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderMapper</span><span class="p">.</span><span class="na">getByNumber</span><span class="p">(</span><span class="n">outTradeNo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ordersDB</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderBusinessException</span><span class="p">(</span><span class="n">MessageConstant</span><span class="p">.</span><span class="na">ORDER_NOT_FOUND</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Orders</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">id</span><span class="p">(</span><span class="n">ordersDB</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Orders</span><span class="p">.</span><span class="na">TO_BE_CONFIRMED</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">payStatus</span><span class="p">(</span><span class="n">Orders</span><span class="p">.</span><span class="na">PAID</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">checkoutTime</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">orderMapper</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">orders</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w"> </span><span class="c1">//1--来单：2--催单</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;orderId&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;contant&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;订单号&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">outTradeNo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">webSocketServer</span><span class="p">.</span><span class="na">sendToAllClient</span><span class="p">(</span><span class="n">json</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<hr>
<h2 id="客户催单">客户催单<a hidden class="anchor" aria-hidden="true" href="#客户催单">#</a></h2>
<h3 id="需求分析和设计-1">需求分析和设计<a hidden class="anchor" aria-hidden="true" href="#需求分析和设计-1">#</a></h3>
<p>接口设计：






    


       
    



<div class="post-img-view">
  <a
    data-fancybox="post-post/java-project/sky-take-out/sky-take-out-13/index.md"
    href="/post/java-project/sky-take-out/sky-take-out-13/6.png"
    data-caption=""
    data-barba-prevent="all"
  >
    <img
      src="/post/java-project/sky-take-out/sky-take-out-13/6.png"
      srcset="/post/java-project/sky-take-out/sky-take-out-13/6.png 2x"
      alt=""
      loading="lazy"
      style="max-width: 100%; height: auto;"
    />
  </a>
    
  
</div>


</p>
<hr>
<h3 id="代码开发-2">代码开发<a hidden class="anchor" aria-hidden="true" href="#代码开发-2">#</a></h3>
<ol>
<li>在user/OrderController中创建催单方法：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* 催单
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param id
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;reminder/{id}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@ApiOperation</span><span class="p">(</span><span class="s">&#34;催单&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">reminder</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;催单：{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">orderService</span><span class="p">.</span><span class="na">reminder</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">success</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
<li>在OrderService接口中声明reminder方法：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* 催单
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param id
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="w"> </span><span class="nf">reminder</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div></li>
<li>在OrderServiceImpl中实现reminder方法：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* 催单
</span></span></span><span class="line"><span class="cl"><span class="cm">*
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param id
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">reminder</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Orders</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderMapper</span><span class="p">.</span><span class="na">getByOrderId</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orders</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderBusinessException</span><span class="p">(</span><span class="n">MessageConstant</span><span class="p">.</span><span class="na">ORDER_NOT_FOUND</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;type&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w"> </span><span class="c1">//1--来单：2--催单</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;orderId&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;contant&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;订单号&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">getNumber</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">webSocketServer</span><span class="p">.</span><span class="na">sendToAllClient</span><span class="p">(</span><span class="n">json</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
</ol>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://www.steamedfish.top/tags/spring-task/">Spring Task</a></li>
      <li><a href="https://www.steamedfish.top/tags/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/">苍穹外卖</a></li>
      <li><a href="https://www.steamedfish.top/tags/websocket/">WebSocket</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://www.steamedfish.top/">©2025 SteamedFish&rsquo;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>
<script src="https://unpkg.com/@barba/core"></script>


<script>
  window.PaperMod = window.PaperMod || {};
  PaperMod.state = { once: false };

  PaperMod.initOnce = function () {
    if (PaperMod.state.once) return;
    PaperMod.state.once = true;

    console.log("PaperMod initOnce");

    if (PaperMod.initAPlayer) {
      PaperMod.initAPlayer();
    }
  };

  PaperMod.initPage = function (container = document) {
    console.log("PaperMod initPage");

    PaperMod.initFancybox && PaperMod.initFancybox(container);
    PaperMod.initCodeCopyButtons && PaperMod.initCodeCopyButtons(container);
  };

  barba.init({
    transitions: [
      {
        name: "default",
        leave() {
          return Promise.resolve();
        },
        enter(data) {
          PaperMod.initOnce();
          PaperMod.initPage(data.next.container);
        },
      },
    ],
  });
  
  document.addEventListener("DOMContentLoaded", () => {
    PaperMod.initOnce();
    PaperMod.initPage(document);
  });
</script>







<link
  href="https://cdn.bootcdn.net/ajax/libs/aplayer/1.10.1/APlayer.min.css"
  rel="stylesheet"
/>
<script src="https://cdn.bootcdn.net/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/meting/2.0.2/Meting.min.js"></script>
<script>
  window.PaperMod = window.PaperMod || {};
  console.log("player.js loaded");
  PaperMod.initAPlayer = async function () {
    if (window.__aplayer_inited__) {
      console.log("APlayer already exists, skip");
      return;
    }

    const container = document.getElementById("aplayer");
    if (!container) {
      console.warn("APlayer container not found");
      return;
    }

    console.log("Init APlayer");
    

    const localAudio = [
      
      
      
      
      
      
      
      
    ];

    

    let metingAudio = [];
    try {
      const res = await fetch(
        
        
        "https://api.qijieya.cn/meting/?type=playlist&id=2245453903"
        
        
      );
      metingAudio = await res.json();
    } catch (e) {
      console.warn("Meting load failed, fallback to local only");
    }

    

    const audioList = [...localAudio, ...metingAudio];

    window.aplayer = new APlayer({
      container,
      fixed: true,
      autoplay: true,
      preload: "auto",
      lrcType: 1,
      
      audio: metingAudio,
    });
    console.log("APlayer created with", audioList.length, "tracks");
  };
</script>



<script>
  window.PaperMod = window.PaperMod || {};

  PaperMod.initCodeCopyButtons = function (root = document) {
    root.querySelectorAll("pre > code").forEach((codeblock) => {
      const container = codeblock.parentNode.parentNode;

      
      if (container.querySelector(".copy-code")) return;

      const copybutton = document.createElement("button");
      copybutton.classList.add("copy-code");
      copybutton.innerHTML = '复制';

      function copyingDone() {
        copybutton.innerHTML = '已复制！';
        setTimeout(() => {
          copybutton.innerHTML = '复制';
        }, 2000);
      }

      copybutton.addEventListener("click", (cb) => {
        if ("clipboard" in navigator) {
          navigator.clipboard.writeText(codeblock.textContent);
          copyingDone();
          return;
        }

        const range = document.createRange();
        range.selectNodeContents(codeblock);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        try {
          document.execCommand("copy");
          copyingDone();
        } catch (e) {}
        selection.removeRange(range);
      });
      container.appendChild(copybutton);
    });
  };
</script>


<link rel="stylesheet" href="/lib/fancybox/fancybox.css" />
<script src="/lib/fancybox/fancybox.umd.js"></script>
<script>
  function initFancybox() {
    Fancybox.unbind("[data-fancybox]");

    Fancybox.bind("[data-fancybox]", {
      animated: true,
      showClass: "fancybox-fadeIn",
      hideClass: "fancybox-fadeOut",
      dragToClose: true,
    });
  }

  
  if (document.readyState !== "loading") {
    initFancybox();
  } else {
    document.addEventListener("DOMContentLoaded", initFancybox);
  }
  
  document.addEventListener("barba:afterEnter", initFancybox);
</script>







<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
